{% extends "lk/lk.html" %}
{% load static %}
{% load tz %}
{% load django_vite %}
{% vite_hmr_client %}

{% block head_js_scripts %}
{% vite_asset 'apps/partners/assets/js/stats/stats.js' %}
{% endblock head_js_scripts %}

{% block title %}Статистика{% endblock title %}

{% block header %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% include "partners/header/header.html" %}
{% endblock %}

{% block main_class %}bg-base-200 min-h-screen{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6 max-w-7xl">
    <div id="partner-stats">
        <!-- Заголовок и основная статистика -->
        <div class="mb-6 sm:mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Статистика партнёра</h1>
                    <p class="text-xs sm:text-sm text-gray-500 mt-1">Обзор вашей партнёрской деятельности</p>
                </div>
                <div class="stats shadow bg-base-100 w-full sm:w-auto">
                    <div class="stat p-3 sm:p-4">
                        <div class="stat-figure text-primary hidden sm:block">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                 class="inline-block w-6 h-6 sm:w-8 sm:h-8 stroke-current">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                            </svg>
                        </div>
                        <div class="stat-title text-xs sm:text-sm">Общий доход</div>
                        <div class="stat-value text-lg sm:text-2xl text-primary">₽{{ total_revenue }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Основные показатели -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6 sm:mb-8">
            <!-- Клики -->
            <div class="stats shadow bg-gradient-to-br from-primary to-primary-focus text-primary-content">
                <div class="stat p-3 sm:p-4">
                    <div class="stat-figure">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5 sm:w-6 sm:h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122" />
                        </svg>
                    </div>
                    <div class="stat-title text-xs sm:text-sm">Клики</div>
                    <div class="stat-value text-lg sm:text-2xl">{{ clicks_count }}</div>
                    <div class="stat-desc text-xs">За все время</div>
                </div>
            </div>

            <!-- Конверсии -->
            <div class="stats shadow bg-gradient-to-br from-secondary to-secondary-focus text-secondary-content">
                <div class="stat p-3 sm:p-4">
                    <div class="stat-figure">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5 sm:w-6 sm:h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div class="stat-title text-xs sm:text-sm">Конверсии</div>
                    <div class="stat-value text-lg sm:text-2xl">{{ conversions_count }}</div>
                    <div class="stat-desc text-xs">CR: {{ request.user.partner_profile.conversions_percent }}%</div>
                </div>
            </div>

            <!-- Доход -->
            <div class="stats shadow bg-gradient-to-br from-accent to-accent-focus text-accent-content">
                <div class="stat p-3 sm:p-4">
                    <div class="stat-figure">
                        <i class="fa-solid fa-ruble-sign"></i>
                    </div>
                    <div class="stat-title text-xs sm:text-sm">Доход</div>
                    <div class="stat-value text-lg sm:text-2xl">{{ total_revenue_last_month }}</div>
                    <div class="stat-desc text-xs">За месяц (30 дней)</div>
                </div>
            </div>

            <!-- Средний чек -->
            <div class="stats shadow bg-gradient-to-br from-info to-info-focus text-info-content">
                <div class="stat p-3 sm:p-4">
                    <div class="stat-figure">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5 sm:w-6 sm:h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                    </div>
                    <div class="stat-title text-xs sm:text-sm">Средний чек</div>
                    <div class="stat-value text-lg sm:text-2xl">₽{{ average_revenue }}</div>
                    <div class="stat-desc text-xs">За все время</div>
                </div>
            </div>
        </div>

        <!-- Графики и аналитика -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 sm:gap-6 mb-6 sm:mb-8">
            <!-- График кликов и конверсий -->
            <div class="lg:col-span-2 bg-base-100 p-4 sm:p-6 rounded-xl shadow-sm transition-all duration-300 hover:shadow-md">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4 sm:mb-6">
                    <h2 class="text-lg sm:text-xl font-semibold">Динамика кликов и конверсий</h2>
                </div>
                <div class="h-48 sm:h-64">
                    <canvas id="clicksConversionsChart"></canvas>
                </div>
            </div>

            <!-- Статистика по проектам -->
            <div class="bg-base-100 p-4 sm:p-6 rounded-xl shadow-sm transition-all duration-300 hover:shadow-md">
                <h2 class="text-lg sm:text-xl font-semibold mb-4 sm:mb-6">Топ проектов</h2>
                <div class="space-y-4">
                    {% for project in top_projects %}
                    <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg">
                        <div class="flex items-center gap-3">
                            <div>
                                <div class="font-medium text-sm"><a href="{% url 'project' project.id %}">{{ project.name }}</a></div>
                                <div class="text-xs text-gray-500">{{ project.conversion_count|default:0 }} конв.</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-sm">₽{{ project.total_amount|default:0 }}</div>
                            <div class="text-xs text-gray-500">{{ project.cr }}% CR</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Статистика по площадкам -->
            <div class="bg-base-100 p-4 sm:p-6 rounded-xl shadow-sm transition-all duration-300 hover:shadow-md">
                <h2 class="text-lg sm:text-xl font-semibold mb-4 sm:mb-6">Топ площадок</h2>
                <div class="space-y-4">
                    {% for platform in top_platforms %}
                    <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg">
                        <div class="flex items-center gap-3">
                            <div>
                                <div class="font-medium text-sm"><a href="{% url 'platform' platform.id %}">{{ platform.name }}</a></div>
                                <div class="text-xs text-gray-500">{{ platform.conversion_count }} конв.</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-sm">₽{{ platform.total_revenue }}</div>
                            <div class="text-xs text-gray-500">{{ platform.conversions_percent }}% CR</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Таблица конверсий -->
        <div class="bg-base-100 rounded-xl shadow-sm overflow-hidden transition-all duration-300 hover:shadow-md mb-6 sm:mb-8">
            <div class="p-4 sm:p-6 border-b border-base-200">
                <h2 class="text-lg sm:text-xl font-semibold">История конверсий</h2>
            </div>

            <!-- Десктопная версия таблицы -->
            <div class="hidden sm:block overflow-x-auto">
                <table class="table">
                    <thead>
                        <tr class="bg-base-200">
                            <th class="text-xs sm:text-sm">ID</th>
                            <th class="text-xs sm:text-sm">Проект</th>
                            <th class="text-xs sm:text-sm">Источник перехода</th>
                            <th class="text-xs sm:text-sm">Дата</th>
                            <th class="text-xs sm:text-sm">Сумма</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for conversion in conversions %}
                        <tr class="hover:bg-base-200 transition-colors duration-150">
                            <td class="text-xs sm:text-sm">#{{ conversion.id }}</td>
                            <td>
                                <div class="flex items-center gap-2 sm:gap-3">
                                    <div>
                                        <div class="font-bold text-xs sm:text-sm">
                                            {% if conversion.project %}
                                            <a href="{% url 'project' conversion.project.id %}">{{ conversion.project.name }}</a>
                                            {% else %}
                                            Удалён
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="font-bold text-xs sm:text-sm">
                                {% if conversion.platform %}
                                <a href="{% url 'platform' conversion.platform.id %}">{{ conversion.platform.name }}</a>
                                {% endif %}
                            </td>
                            <td class="text-xs sm:text-sm">{{ conversion.created_at }}</td>
                            <td class="text-xs sm:text-sm">₽{{ conversion.amount }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% if not conversions %}
                <div class="flex flex-col justify-center items-center text-center py-10" id="empty-state">
                    <div class="text-orange-400 text-5xl mb-4">
                        <i class="fas fa-flag"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-500 mb-2">Ваши первые конверсии ждут вас!</h3>
                    <p class="text-gray-400 text-sm mb-4">Подключитесь к проектам и начните получать комиссию за каждую продажу. Первые конверсии появятся здесь</p>
                </div>
                {% endif %}
            </div>

            <!-- Мобильная версия таблицы (карточки) -->
            <div class="sm:hidden space-y-3 p-3">
                {% for conversion in conversions %}
                <div class="card bg-base-100 shadow-sm border border-base-200">
                    <div class="card-body p-4">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="card-title text-sm font-bold">#{{ conversion.id }}</h3>
                                <p class="text-xs font-bold">
                                    {% if conversions.project %}
                                    <a href="{% url 'project' conversion.project.id %}">{{ conversion.project.name }}</a>
                                    {% else %}
                                    Удалён
                                    {% endif %}
                                </p>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3 text-xs">
                            <div>
                                <div class="text-gray-500">Дата</div>
                                <div>{{ conversion.created_at }}</div>
                            </div>
                            <div>
                                <div class="text-gray-500">Сумма</div>
                                <div class="font-medium">₽{{ conversion.amount }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Пагинация -->
        <div class="pagination flex flex-wrap justify-center items-center gap-2 my-6 px-2">
            {% if conversions.has_previous %}
            <a href="?conversions_page=1"
               class="btn btn-sm btn-square md:btn-md btn-primary transition-all duration-200 hover:scale-105"
               aria-label="Первая страница">
                <i class="fas fa-angle-double-left"></i>
            </a>
            <a href="?conversions_page={{ conversions.previous_page_number }}"
               class="btn btn-sm md:btn-md btn-outline transition-all duration-200 hover:scale-[1.02]">
                <span class="hidden sm:inline">Предыдущая</span>
                <span class="sm:hidden"><i class="fas fa-chevron-left"></i></span>
            </a>
            {% endif %}

            <div class="flex items-center mx-1 md:mx-3 text-sm md:text-base">
                <span class="hidden sm:inline">Страница</span>
                <input type="number" min="1" max="{{ conversions.paginator.num_pages }}"
                       value="{{ conversions.number }}"
                       class="input input-bordered input-sm md:input-md w-12 md:w-16 mx-1 md:mx-2 text-center transition-all duration-200 focus:ring-2 focus:ring-primary focus:border-transparent"
                       onchange="window.location.href = '?conversions_page=' + this.value"
                       aria-label="Номер страницы">
                <span>из {{ conversions.paginator.num_pages }}</span>
            </div>

            {% if conversions.has_next %}
            <a href="?conversions_page={{ conversions.next_page_number }}"
               class="btn btn-sm md:btn-md btn-outline transition-all duration-200 hover:scale-[1.02]">
                <span class="hidden sm:inline">Следующая</span>
                <span class="sm:hidden"><i class="fas fa-chevron-right"></i></span>
            </a>
            <a href="?conversions_page={{ conversions.paginator.num_pages }}"
               class="btn btn-sm btn-square md:btn-md btn-primary transition-all duration-200 hover:scale-105"
               aria-label="Последняя страница">
                <i class="fas fa-angle-double-right"></i>
            </a>
            {% endif %}
        </div>
    </div>
</div>

<script>
const chartData = JSON.parse('{{ conversions_json|safe }}');

// Создаем график
const ctx = document.getElementById('clicksConversionsChart').getContext('2d');
const conversionsChart = new Chart(ctx, {
    type: 'line',
    data: chartData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            title: {
                display: true,
                text: 'Динамика кликов и конверсий по дням',
                font: {
                    size: 16
                }
            },
            tooltip: {
                mode: 'index',
                intersect: false,
            },
            legend: {
                position: 'top',
            }
        },
        scales: {
            x: {
                display: true,
                title: {
                    display: true,
                    text: 'Дата'
                },
                grid: {
                    display: false
                }
            },
            y: {
                display: true,
                title: {
                    display: true,
                    text: 'Количество'
                },
                beginAtZero: true
            }
        },
        interaction: {
            intersect: false,
            mode: 'nearest'
        }
    }
});
</script>
{% endblock %}